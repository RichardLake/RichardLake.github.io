<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\richard\documents\ckansplit\ckan-core\tests\ckan\cache.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.IO;
using NUnit.Framework;

namespace CKANTests
{
    [TestFixture]
    public class Cache
    {
        private readonly string cache_dir = Path.Combine(Tests.TestData.DataDir(),&quot;cache_test&quot;);

        private CKAN.NetFileCache cache;

        [SetUp]
        public void MakeCache()
        {
            Directory.CreateDirectory(cache_dir);
            cache = new CKAN.NetFileCache(cache_dir);
        }

        [TearDown]
        public void RemoveCache()
        {
            Directory.Delete(cache_dir, true);
        }

        [Test]
        public void Sanity()
        {
            Assert.IsInstanceOf&lt;CKAN.NetFileCache&gt;(cache);
            Assert.IsTrue(Directory.Exists(cache.GetCachePath()));
        }

        [Test]
        public void StoreRetrieve()
        {
            Uri url = new Uri(&quot;http://example.com/&quot;);
            string file = Tests.TestData.DogeCoinFlagZip();

            // Sanity check, our cache dir is there, right?
            Assert.IsTrue(Directory.Exists(cache.GetCachePath()));

            // Our URL shouldn&#39;t be cached to begin with.
            Assert.IsFalse(cache.IsCached(url));

            // Store our file.
            cache.Store(url, file);

            // Now it should be cached.
            Assert.IsTrue(cache.IsCached(url));

            // Check contents match.
            string cached_file = cache.GetCachedFilename(url);
            FileAssert.AreEqual(file, cached_file);
        }

        [Test]
        public void NamingHints()
        {
            Uri url = new Uri(&quot;http://example.com/&quot;);
            string file = Tests.TestData.DogeCoinFlagZip();

            Assert.IsFalse(cache.IsCached(url));
            cache.Store(url, file, &quot;cheesy.zip&quot;);

            StringAssert.EndsWith(&quot;cheesy.zip&quot;, cache.GetCachedFilename(url));
        }

        [Test]
        public void StoreRemove()
        {
            Uri url = new Uri(&quot;http://example.com/&quot;);
            string file = Tests.TestData.DogeCoinFlagZip();

            Assert.IsFalse(cache.IsCached(url));
            cache.Store(url, file);
            Assert.IsTrue(cache.IsCached(url));

            cache.Remove(url);

            Assert.IsFalse(cache.IsCached(url));
        }

        [Test]
        public void CacheKraken()
        {
            string dir = &quot;/this/path/better/not/exist&quot;;

            try
            {
                new CKAN.NetFileCache(dir);
            }
            catch (CKAN.DirectoryNotFoundKraken kraken)
            {
                Assert.AreSame(dir,kraken.directory);
            }
        }

        [Test]
        public void DoubleCache()
        {
            // Store and flip files in our cache. We should always get
            // the most recent file we store for any given URL.

            Uri url = new Uri(&quot;http://Double.Rainbow.What.Does.It.Mean/&quot;);
            Assert.IsFalse(cache.IsCached(url));

            string file1 = Tests.TestData.DogeCoinFlagZip();
            string file2 = Tests.TestData.ModuleManagerZip();

            cache.Store(url, file1);
            FileAssert.AreEqual(file1, cache.GetCachedFilename(url));

            cache.Store(url, file2);
            FileAssert.AreEqual(file2, cache.GetCachedFilename(url));

            cache.Store(url, file1);
            FileAssert.AreEqual(file1, cache.GetCachedFilename(url));
        }

        [Test]
        public void ZipValidation()
        {
            // We could use any URL, but this one is awesome. &lt;3
            Uri url = new Uri(&quot;http://kitte.nz/&quot;);

            Assert.IsFalse(cache.IsCachedZip(url));

            // Store a bad zip.
            cache.Store(url, Tests.TestData.DogeCoinFlagZipCorrupt());

            // Make sure it&#39;s stored, but not valid as a zip
            Assert.IsTrue(cache.IsCached(url));
            Assert.IsFalse(cache.IsCachedZip(url));

            // Store a good zip.
            cache.Store(url, Tests.TestData.DogeCoinFlagZip());

            // Make sure it&#39;s stored, and valid.
            Assert.IsTrue(cache.IsCached(url));
            Assert.IsTrue(cache.IsCachedZip(url));
        }
    }
}


    </pre>
    <script type="text/javascript">
      highlightRanges([[92,13,92,14,0],[16,9,16,10,1],[17,13,17,50,1],[18,13,18,54,1],[19,9,19,10,1],[23,9,23,10,1],[24,13,24,47,1],[25,9,25,10,1],[29,9,29,10,1],[30,13,30,59,1],[31,13,31,67,1],[32,9,32,10,1],[36,9,36,10,1],[37,13,37,54,1],[38,13,38,60,1],[41,13,41,67,1],[44,13,44,49,1],[47,13,47,36,1],[50,13,50,48,1],[53,13,53,63,1],[54,13,54,52,1],[55,9,55,10,1],[59,9,59,10,1],[60,13,60,54,1],[61,13,61,60,1],[63,13,63,49,1],[64,13,64,50,1],[66,13,66,79,1],[67,9,67,10,1],[71,9,71,10,1],[72,13,72,54,1],[73,13,73,60,1],[75,13,75,49,1],[76,13,76,36,1],[77,13,77,48,1],[79,13,79,31,1],[81,13,81,49,1],[82,9,82,10,1],[86,9,86,10,1],[87,13,87,56,1],[90,13,90,14,1],[91,17,91,44,1],[93,13,93,56,1],[94,13,94,14,1],[95,17,95,54,1],[96,13,96,14,1],[97,9,97,10,1],[101,9,101,10,1],[105,13,105,75,1],[106,13,106,49,1],[108,13,108,61,1],[109,13,109,62,1],[111,13,111,37,1],[112,13,112,70,1],[114,13,114,37,1],[115,13,115,70,1],[117,13,117,37,1],[118,13,118,70,1],[119,9,119,10,1],[123,9,123,10,1],[125,13,125,51,1],[127,13,127,52,1],[130,13,130,71,1],[133,13,133,48,1],[134,13,134,52,1],[137,13,137,64,1],[140,13,140,48,1],[141,13,141,51,1],[142,9,142,10,1],[10,9,10,97,1]]);
    </script>
  </body>
</html>