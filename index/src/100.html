<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\richard\documents\ckansplit\ckan-core\tests\ckan\net\netasyncdownloader.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using NUnit.Framework;
using Tests;
using log4net;
using log4net.Core;
using log4net.Config;

namespace CKANTests
{
    /// &lt;summary&gt;
    /// Test the async downloader.
    /// &lt;/summary&gt;
    
    [TestFixture]
    public class NetAsyncDownloader
    {

        private CKAN.Registry registry;
        private DisposableKSP ksp;
        private CKAN.NetAsyncDownloader async;
        private CKAN.NetFileCache cache;

        private static readonly ILog log = LogManager.GetLogger(typeof (NetAsyncDownloader));

        [SetUp]
        public void Setup()
        {
            // Make sure curl is all set up.
            CKAN.Curl.Init();

            // Give us a registry to play with.
            ksp = new DisposableKSP();
            registry = ksp.KSP.Registry;

            registry.ClearAvailable();
            registry.ClearDlls();
            registry.Installed().Clear();

            // Make sure we have a registry we can use.
            CKAN.Repo.UpdateRegistry(TestData.TestKAN(), registry, ksp.KSP, new CKAN.NullUser());

            // Ready our downloader.
            async = new CKAN.NetAsyncDownloader(new CKAN.NullUser());

            // General shortcuts
            cache = ksp.KSP.Cache;
        }

        [TearDown]
        public void TearDown()
        {
            CKAN.Curl.CleanUp();
            ksp.Dispose();
        }

        [Test]
        [Category(&quot;Online&quot;)]
        [Category(&quot;NetAsyncDownloader&quot;)]
        [Explicit]
        public void SingleDownload()
        {
            // Force log4net on.
            // BasicConfigurator.Configure();
            // LogManager.GetRepository().Threshold = Level.Debug;
            log.Info(&quot;Performing single download test.&quot;);

            // We know kOS is in the TestKAN data, and hosted in KS. Let&#39;s get it.

            var modules = new List&lt;CKAN.CkanModule&gt;();

            CKAN.CkanModule kOS = registry.LatestAvailable(&quot;kOS&quot;, null);
            Assert.IsNotNull(kOS);

            modules.Add(kOS);

            // Make sure we don&#39;t alread have kOS somehow.
            Assert.IsFalse(cache.IsCached(kOS.download));

            //
            log.InfoFormat(&quot;Downloading kOS from {0}&quot;,kOS.download);

            // Download our module.
            async.DownloadModules(
                ksp.KSP.Cache,
                modules
            );

            // Assert that we have it, and it passes zip validation.
            Assert.IsTrue(cache.IsCachedZip(kOS.download));
        }

        [Test]
        [Category(&quot;Online&quot;)]
        [Category(&quot;NetAsyncDownloader&quot;)]
        [Explicit]
        public void MultiDownload()
        {
            var modules = new List&lt;CKAN.CkanModule&gt;();

            CKAN.CkanModule kOS = registry.LatestAvailable(&quot;kOS&quot;, null);
            CKAN.CkanModule QuickRevert = registry.LatestAvailable(&quot;QuickRevert&quot;, null);

            modules.Add(kOS);
            modules.Add(QuickRevert);

            Assert.IsFalse(cache.IsCachedZip(kOS.download));
            Assert.IsFalse(cache.IsCachedZip(QuickRevert.download));

            async.DownloadModules(cache, modules);

            Assert.IsTrue(cache.IsCachedZip(kOS.download));
            Assert.IsTrue(cache.IsCachedZip(QuickRevert.download));
        }

        [Test]
        [Category(&quot;Online&quot;)]
        [Category(&quot;NetAsyncDownloader&quot;)]
        [Explicit]
        public void RandSdownload()
        {
            var modules = new List&lt;CKAN.CkanModule&gt;();

            var rAndS = TestData.RandSCapsuleDyneModule();

            modules.Add(rAndS);

            Assert.IsFalse(cache.IsCachedZip(rAndS.download), &quot;Module not yet downloaded&quot;);

            async.DownloadModules(cache, modules);

            Assert.IsTrue(cache.IsCachedZip(rAndS.download),&quot;Module download successful&quot;);
        }

    }
}


    </pre>
    <script type="text/javascript">
      highlightRanges([[28,9,28,10,0],[30,13,30,30,0],[33,13,33,39,0],[34,13,34,41,0],[36,13,36,39,0],[37,13,37,34,0],[38,13,38,42,0],[41,13,41,98,0],[44,13,44,70,0],[47,13,47,35,0],[48,9,48,10,0],[52,9,52,10,0],[53,13,53,33,0],[54,13,54,27,0],[55,9,55,10,0],[62,9,62,10,0],[66,13,66,58,0],[70,13,70,55,0],[72,13,72,73,0],[73,13,73,35,0],[75,13,75,30,0],[78,13,78,58,0],[81,13,81,69,0],[84,13,87,15,0],[90,13,90,60,0],[91,9,91,10,0],[98,9,98,10,0],[99,13,99,55,0],[101,13,101,73,0],[102,13,102,89,0],[104,13,104,30,0],[105,13,105,38,0],[107,13,107,61,0],[108,13,108,69,0],[110,13,110,51,0],[112,13,112,60,0],[113,13,113,68,0],[114,9,114,10,0],[121,9,121,10,0],[122,13,122,55,0],[124,13,124,59,0],[126,13,126,32,0],[128,13,128,92,0],[130,13,130,51,0],[132,13,132,91,0],[133,9,133,10,0],[24,9,24,94,1]]);
    </script>
  </body>
</html>