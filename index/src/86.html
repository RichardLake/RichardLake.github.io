<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\richard\documents\ckansplit\ckan-core\tests\ckan\registry\registry.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System.Transactions;
using CKAN;
using NUnit.Framework;
using Tests;

namespace CKANTests
{
    [TestFixture]
    public class Registry
    {
        private static readonly CkanModule module = TestData.kOS_014_module();
        private static readonly string identifier = module.identifier;
        private static readonly CKAN.KSPVersion v0_24_2 = new CKAN.KSPVersion(&quot;0.24.2&quot;);
        private static readonly CKAN.KSPVersion v0_25_0 = new CKAN.KSPVersion(&quot;0.25.0&quot;);

        private CKAN.Registry registry;

        [SetUp]
        public void Setup()
        {
            // Provide an empty registry before each test.
            registry = CKAN.Registry.Empty();
            Assert.IsNotNull(registry);
        }

        [Test]
        public void Empty()
        {
            CKAN.Registry registry = CKAN.Registry.Empty();
            Assert.IsInstanceOf&lt;CKAN.Registry&gt;(registry);

        }

        [Test]
        public void AddAvailable()
        {
            // We shouldn&#39;t have kOS in our registry.
            Assert.IsFalse(registry.available_modules.ContainsKey(module.identifier));

            // Register
            registry.AddAvailable(module);

            // Make sure it&#39;s now there.
            Assert.IsTrue(registry.available_modules.ContainsKey(module.identifier));
        }

        [Test]
        public void RemoveAvailableByName()
        {
            // Add our module and test it&#39;s there.
            registry.AddAvailable(module);
            Assert.IsNotNull(registry.LatestAvailable(identifier, v0_24_2));

            // Remove it, and make sure it&#39;s gone.
            registry.RemoveAvailable(identifier, module.version);

            Assert.IsNull(registry.LatestAvailable(identifier, v0_24_2));
        }

        [Test]
        public void RemoveAvailableByModule()
        {
            // Add our module and test it&#39;s there.
            registry.AddAvailable(module);
            Assert.IsNotNull(registry.LatestAvailable(identifier, v0_24_2));

            // Remove it, and make sure it&#39;s gone.
            registry.RemoveAvailable(module);

            Assert.IsNull(registry.LatestAvailable(identifier, v0_24_2));
        }

        [Test]
        public void LatestAvailable()
        {

            registry.AddAvailable(module);

            // Make sure it&#39;s there for 0.24.2
            Assert.AreEqual(module.ToString(), registry.LatestAvailable(identifier, v0_24_2).ToString());

            // But not for 0.25.0
            Assert.IsNull(registry.LatestAvailable(identifier, v0_25_0));

            // And that we fail if we ask for something we don&#39;t know.
            Assert.Throws&lt;ModuleNotFoundKraken&gt;(delegate
            {
                registry.LatestAvailable(&quot;ToTheMun&quot;, v0_24_2);
            });
        }

        [Test]
        public void TxEmbeddedCommit()
        {
            // Our registry should work when we initialise it inside our Tx and commit.

            CKAN.Registry reg;

            using (var scope = new TransactionScope())
            {
                reg = CKAN.Registry.Empty();
                reg.AddAvailable(module);
                Assert.AreEqual(identifier, reg.LatestAvailable(identifier, null).identifier);
                scope.Complete();
            }
            Assert.AreEqual(identifier, reg.LatestAvailable(identifier, null).identifier);
        }

        [Test]
        public void TxCommit()
        {
            // Our registry should work fine on committed transactions.

            using (var scope = new TransactionScope())
            {
                registry.AddAvailable(module);
                Assert.AreEqual(module.identifier, registry.LatestAvailable(identifier, null).identifier);

                scope.Complete();
            }
            Assert.AreEqual(module.identifier, registry.LatestAvailable(identifier, null).identifier);
        }

        [Test]
        public void TxRollback()
        {
            // Our registry should roll-back any changes it made during a transaction.

            using (var scope = new TransactionScope())
            {
                registry.AddAvailable(module);
                Assert.AreEqual(module.identifier, registry.LatestAvailable(identifier,null).identifier);

                scope.Dispose(); // Rollback, our module should no longer be available.
            }

            Assert.Throws&lt;ModuleNotFoundKraken&gt;(delegate
            {
                registry.LatestAvailable(identifier,null);
            });
        }

        [Test]
        public void TxNested()
        {
            // Our registry doesn&#39;t understand how to do nested transactions,
            // make sure it throws on these.

            using (var scope = new TransactionScope())
            {
                registry.AddAvailable(module);

                using (var scope2 = new TransactionScope(TransactionScopeOption.RequiresNew))
                {
                    Assert.Throws&lt;TransactionalKraken&gt;(delegate
                    {
                        registry.AddAvailable(TestData.DogeCoinFlag_101_module());
                    });
                    scope2.Complete();
                }
                scope.Complete();
            }
        }

        [Test]
        public void TxAmbient()
        {
            // Our registry should be fine with ambient transactions, which join together.
            // Note the absence of TransactionScopeOption.RequiresNew

            using (var scope = new TransactionScope())
            {
                registry.AddAvailable(module);

                using (var scope2 = new TransactionScope())
                {
                    Assert.DoesNotThrow(delegate
                    {
                        registry.AddAvailable(TestData.DogeCoinFlag_101_module());
                    });
                    scope2.Complete();
                }
                scope.Complete();
            }
        }
    }
}


    </pre>
    <script type="text/javascript">
      highlightRanges([[89,13,89,14,0],[140,13,140,14,0],[158,21,158,22,0],[20,9,20,10,1],[22,13,22,46,1],[23,13,23,40,1],[24,9,24,10,1],[28,9,28,10,1],[29,13,29,60,1],[30,13,30,58,1],[32,9,32,10,1],[36,9,36,10,1],[38,13,38,87,1],[41,13,41,43,1],[44,13,44,86,1],[45,9,45,10,1],[49,9,49,10,1],[51,13,51,43,1],[52,13,52,77,1],[55,13,55,66,1],[57,13,57,74,1],[58,9,58,10,1],[62,9,62,10,1],[64,13,64,43,1],[65,13,65,77,1],[68,13,68,46,1],[70,13,70,74,1],[71,9,71,10,1],[75,9,75,10,1],[77,13,77,43,1],[80,13,80,106,1],[83,13,83,74,1],[86,13,87,13,1],[87,14,88,17,1],[88,63,89,13,1],[89,14,89,16,1],[90,9,90,10,1],[94,9,94,10,1],[99,20,99,54,1],[100,13,100,14,1],[101,17,101,45,1],[102,17,102,42,1],[103,17,103,95,1],[104,17,104,34,1],[105,13,105,14,1],[106,13,106,91,1],[107,9,107,10,1],[111,9,111,10,1],[114,20,114,54,1],[115,13,115,14,1],[116,17,116,47,1],[117,17,117,107,1],[119,17,119,34,1],[120,13,120,14,1],[121,13,121,103,1],[122,9,122,10,1],[126,9,126,10,1],[129,20,129,54,1],[130,13,130,14,1],[131,17,131,47,1],[132,17,132,106,1],[134,17,134,33,1],[135,13,135,14,1],[137,13,138,13,1],[138,14,139,17,1],[139,59,140,13,1],[140,14,140,16,1],[141,9,141,10,1],[145,9,145,10,1],[149,20,149,54,1],[150,13,150,14,1],[151,17,151,47,1],[153,24,153,93,1],[154,17,154,18,1],[155,21,156,21,1],[156,22,157,25,1],[157,83,158,21,1],[158,22,158,24,1],[159,21,159,39,1],[160,17,160,18,1],[161,17,161,34,1],[162,13,162,14,1],[163,9,163,10,1],[167,9,167,10,1],[171,20,171,54,1],[172,13,172,14,1],[173,17,173,47,1],[175,24,175,59,1],[176,17,176,18,1],[177,21,178,21,1],[178,22,179,25,1],[179,83,180,21,1],[180,22,180,24,1],[181,21,181,39,1],[182,17,182,18,1],[183,17,183,34,1],[184,13,184,14,1],[185,9,185,10,1],[11,9,11,79,1],[12,9,12,71,1],[13,9,13,89,1],[14,9,14,89,1],[87,13,87,14,1],[88,17,88,63,1],[138,13,138,14,1],[139,17,139,59,1],[156,21,156,22,1],[157,25,157,83,1],[178,21,178,22,1],[179,25,179,83,1],[180,21,180,22,1]]);
    </script>
  </body>
</html>