<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>c:\users\richard\documents\ckansplit\ckan-core\tests\ckan\kspmanager.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using System;
using System.Collections.Generic;
using System.Linq;
using CKAN;
using NUnit.Framework;
using Tests;

namespace CKANTests
{
    [TestFixture] public class KSPManagerTests
    {
        private DisposableKSP tidy;
        private const string nameInReg = &quot;testing&quot;;
        private FakeWin32Registry win32_reg;
        KSPManager manager;

        [SetUp]
        public void SetUp()
        {
            tidy = new DisposableKSP();
            win32_reg = GetTestWin32Reg(nameInReg);            
            manager = new KSPManager(new NullUser(), win32_reg);
        }

        [TearDown]
        public void TearDown()
        {
            tidy.Dispose();
        }

        [Test]
        public void HasInstance_ReturnsFalseIfNoInstanceByThatName()
        {
            const string anyNameNotInReg = &quot;Games&quot;;                        
            Assert.That(manager.HasInstance(anyNameNotInReg), Is.EqualTo(false));
        }

        [Test]
        public void HasInstance_ReturnsTrueIfInstanceByThatName()
        {            
            Assert.That(manager.HasInstance(nameInReg), Is.EqualTo(true));
        }

        [Test]
        public void SetAutoStart_VaildName_SetsAutoStart()
        {         
            Assert.That(manager.AutoStartInstance, Is.EqualTo(null));

            manager.SetAutoStart(nameInReg);
            Assert.That(manager.AutoStartInstance, Is.EqualTo(nameInReg));
        }

        [Test]
        public void SetAutoStart_InvaildName_DoesNotChangeAutoStart()
        {
            manager.SetAutoStart(nameInReg);
            Assert.Throws&lt;InvalidKSPInstanceKraken&gt;(() =&gt; manager.SetAutoStart(&quot;invaild&quot;));
            Assert.That(manager.AutoStartInstance, Is.EqualTo(nameInReg));
        }

        [Test]
        public void RemoveInstance_HasInstanceReturnsFalse()
        {
            manager.RemoveInstance(nameInReg);
            Assert.False(manager.HasInstance(nameInReg));
        }

        [Test]
        public void RenameInstance_HasInstanceOriginalName_ReturnsFalse()
        {
            manager.RenameInstance(nameInReg,&quot;newname&quot;);
            Assert.False(manager.HasInstance(nameInReg));
        }
        [Test]
        public void RenameInstance_HasInstanceNewName()
        {
            const string newname = &quot;newname&quot;;
            manager.RenameInstance(nameInReg, newname);
            Assert.True(manager.HasInstance(newname));
        }
        
        [Test]
        public void ClearAutoStart_UpdatesValueInWin32Reg()
        {

            Assert.That(win32_reg.AutoStartInstance, Is.Null.Or.Empty);
            
        }

        [Test]
        public void GetNextValidInstanceName_ManagerDoesNotHaveResult()
        {
            var name = manager.GetNextValidInstanceName(nameInReg);
            Assert.That(manager.HasInstance(name),Is.False);
            
        }

        [Test]
        public void AddInstance_ManagarHasInstance()
        {
            using (var tidy2 = new DisposableKSP())
            {                
                const string newInstance = &quot;tidy2&quot;;
                Assert.That(manager.HasInstance(newInstance), Is.False);
                manager.AddInstance(newInstance, tidy2.KSP);
                Assert.That(manager.HasInstance(newInstance),Is.True);
            }
        }

        [Test]
        public void GetPreferredInstance_WithAutoStart_ReturnsAutoStart()
        {
            Assert.That(manager.GetPreferredInstance(),Is.EqualTo(tidy.KSP));
        }

        [Test]
        public void GetPreferredInstance_WithEmptyAutoStartAndMultipleInstances_ReturnsNull()
        {
            using (var tidy2 = new DisposableKSP())
            {
                win32_reg.Instances.Add(new Tuple&lt;string, string&gt;(&quot;tidy2&quot;,tidy2.KSP.GameDir()));
                manager.LoadInstancesFromRegistry();
                manager.ClearAutoStart();
                Assert.That(manager.GetPreferredInstance(), Is.Null);
            }
            
        }

        [Test]
        public void GetPreferredInstance_OnlyOneAvailable_ReturnsAvailable()
        {
            manager.ClearAutoStart();
            Assert.That(manager.GetPreferredInstance(), Is.EqualTo(tidy.KSP));
        }

        [Test]
        public void SetCurrentInstance_NameNotInRepo_Throws()
        {
            Assert.Throws&lt;InvalidKSPInstanceKraken&gt;(() =&gt; manager.SetCurrentInstance(&quot;invaild&quot;));
        }

        [Test] //37a33
        public void Ctor_InvaildAutoStart_DoesNotThrow()
        {
            Assert.DoesNotThrow(() =&gt; new KSPManager(new NullUser(),new FakeWin32Registry(tidy.KSP,&quot;invaild&quot;)
                ));
        }


        //TODO Test FindAndRegisterDefaultInstance

        private FakeWin32Registry GetTestWin32Reg(string name)
        {
            return new FakeWin32Registry(new List&lt;Tuple&lt;string, string&gt;&gt;
            {
                new Tuple&lt;string, string&gt;(name, tidy.KSP.GameDir())
            });
        }
    }

    public class FakeWin32Registry : IWin32Registry
    {
        public FakeWin32Registry(CKAN.KSP instance,string autostart)
        {
            Instances = new List&lt;Tuple&lt;string, string&gt;&gt;
            {
                new Tuple&lt;string, string&gt;(&quot;test&quot;, instance.GameDir())
            };
            AutoStartInstance = autostart;
        }

        public FakeWin32Registry(CKAN.KSP instance):this(instance, &quot;test&quot;)
        {
            
        }


        public FakeWin32Registry(List&lt;Tuple&lt;string, string&gt;&gt; instances, string auto_start_instance = null)
        {
            Instances = instances;
            AutoStartInstance = auto_start_instance;
        }

        public List&lt;Tuple&lt;string, string&gt;&gt; Instances { get; set; }

        public int InstanceCount
        {
            get { return Instances.Count; }
            }

        public string AutoStartInstance { get; set; }

        public Tuple&lt;string, string&gt; GetInstance(int i)
        {
            return Instances[i];
        }

        public void SetRegistryToInstances(SortedList&lt;string, CKAN.KSP&gt; instances, string auto_start_instance)
        {
            Instances =
                instances.Select((kvpair) =&gt; new Tuple&lt;string, string&gt;(kvpair.Key, kvpair.Value.GameDir())).ToList();
            AutoStartInstance = auto_start_instance;
        }

        public IEnumerable&lt;Tuple&lt;string, string&gt;&gt; GetInstances()
        {
            return Instances;
        }
    }
}
    </pre>
    <script type="text/javascript">
      highlightRanges([[188,17,188,18,0],[188,19,188,42,0],[188,43,188,44,0],[194,9,194,10,0],[195,13,195,33,0],[196,9,196,10,0],[19,9,19,10,1],[20,13,20,40,1],[21,13,21,52,1],[22,13,22,65,1],[23,9,23,10,1],[27,9,27,10,1],[28,13,28,28,1],[29,9,29,10,1],[33,9,33,10,1],[35,13,35,82,1],[36,9,36,10,1],[40,9,40,10,1],[41,13,41,75,1],[42,9,42,10,1],[46,9,46,10,1],[47,13,47,70,1],[49,13,49,45,1],[50,13,50,75,1],[51,9,51,10,1],[55,9,55,10,1],[56,13,56,45,1],[57,13,57,59,1],[57,90,57,92,1],[58,13,58,75,1],[59,9,59,10,1],[63,9,63,10,1],[64,13,64,47,1],[65,13,65,58,1],[66,9,66,10,1],[70,9,70,10,1],[71,13,71,57,1],[72,13,72,58,1],[73,9,73,10,1],[76,9,76,10,1],[78,13,78,56,1],[79,13,79,55,1],[80,9,80,10,1],[84,9,84,10,1],[86,13,86,72,1],[88,9,88,10,1],[92,9,92,10,1],[93,13,93,68,1],[94,13,94,61,1],[96,9,96,10,1],[100,9,100,10,1],[101,20,101,51,1],[102,13,102,14,1],[104,17,104,73,1],[105,17,105,61,1],[106,17,106,71,1],[107,13,107,14,1],[108,9,108,10,1],[112,9,112,10,1],[113,13,113,78,1],[114,9,114,10,1],[118,9,118,10,1],[119,20,119,51,1],[120,13,120,14,1],[121,17,121,97,1],[122,17,122,53,1],[123,17,123,42,1],[124,17,124,70,1],[125,13,125,14,1],[127,9,127,10,1],[131,9,131,10,1],[132,13,132,38,1],[133,13,133,79,1],[134,9,134,10,1],[138,9,138,10,1],[139,13,139,59,1],[139,96,139,98,1],[140,9,140,10,1],[144,9,144,10,1],[145,13,145,39,1],[146,18,146,20,1],[147,9,147,10,1],[153,9,153,10,1],[154,13,157,16,1],[158,9,158,10,1],[57,59,57,90,1],[139,59,139,96,1],[145,39,146,18,1],[163,9,163,69,1],[164,9,164,10,1],[165,13,168,15,1],[169,13,169,43,1],[170,9,170,10,1],[172,53,172,75,1],[173,9,173,10,1],[175,9,175,10,1],[178,9,178,107,1],[179,9,179,10,1],[180,13,180,35,1],[181,13,181,53,1],[182,9,182,10,1],[184,56,184,60,1],[184,61,184,65,1],[191,43,191,47,1],[191,48,191,52,1],[199,9,199,10,1],[200,13,201,46,1],[201,107,201,118,1],[202,13,202,53,1],[203,9,203,10,1],[206,9,206,10,1],[207,13,207,30,1],[208,9,208,10,1],[201,46,201,107,1]]);
    </script>
  </body>
</html>